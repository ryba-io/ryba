
# Hive Server Backup

The backup script dump the content of the hive database as well as the logs.

    module.exports = []
    module.exports.push 'masson/bootstrap/'
    module.exports.push require('./server').configure

## Database

    module.exports.push name: "Hive Server # Database", handler: (ctx, next) ->
      {hive} = ctx.config.ryba
      username = hive.site['javax.jdo.option.ConnectionUserName']
      password = hive.site['javax.jdo.option.ConnectionPassword']
      {engine, db, hostname, port} = parse_jdbc hive.site['javax.jdo.option.ConnectionURL']
      engines = 
        mysql: ->
          escape = (text) -> text.replace(/[\\"]/g, "\\$&")
          ctx.execute
            cmd: """
            mysqldump \
              -u{username} -p#{password} \
              -h#{hostname} -P#{port} \
              #{db} \
              | gzip > /var/tmp/ryba-hive-db-#{Date.now()}.gz
            """
            code_skipped: 2
          , next
      return next new Error 'Database engine not supported' unless engines[engine]
      engines[engine]()

## Logs

Archive the logs generated by the Hive Server2 and remove them from the log
directory.

    module.exports.push name: "Hive Server # Logs", handler: (ctx, next) ->
      ctx.execute
        cmd: """
        ts=`date +%s`
        mkdir /tmp/ryba-hive-conf-$ts
        cp -rp /var/log/hive/hive-server2.log.* /tmp/ryba-hive-conf-$ts
        tar czf /var/tmp/ryba-hive-log-$ts.tgz -C /tmp/ryba-hive-conf-$ts .
        rm -rf /tmp/ryba-hive-conf-$ts
        """
      , next

## Configuration

Backup the active Hive configuration.

    module.exports.push name: "Hive Server # Configuration", handler: (ctx, next) ->
      ctx.execute
        cmd: """
        ts=`date +%s`
        cp -rp /etc/hive/conf /tmp/ryba-hive-conf-$ts
        tar czf /var/tmp/ryba-hive-conf-#{now}.tgz -C /tmp/ryba-hive-conf-$ts .
        rm -rf /tmp/ryba-hive-conf-$ts
        """
      , next


