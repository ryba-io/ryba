
# Hive Server Backup

The backup script dump the content of the hive database as well as the logs.

    module.exports = []
    module.exports.push require('./server').configure

## Database

    module.exports.push name: "Hive Server # Database", callback: (ctx, next) ->
      {hive_site} = ctx.config.ryba
      username = hive_site['javax.jdo.option.ConnectionUserName']
      password = hive_site['javax.jdo.option.ConnectionPassword']
      {engine, db, hostname, port} = parse_jdbc hive_site['javax.jdo.option.ConnectionURL']
      engines = 
        mysql: ->
          escape = (text) -> text.replace(/[\\"]/g, "\\$&")
          ctx.execute
            cmd: """
            mysqldump \
              -u{username} -p#{password} \
              -h#{hostname} -P#{port} \
              #{db} \
              | gzip > /var/tmp/ryba-hive-db-#{Date.now()}.gz
            """
            code_skipped: 2
          , next
      return next new Error 'Database engine not supported' unless engines[engine]
      engines[engine]()

## Logs

Archive the logs generated by the Hive Server2 and remove them from the log
directory.

    module.exports.push name: "Hive Server # Logs", callback: (ctx, next) ->
      ctx.execute
        cmd: """
        ts=`date +%s`
        mkdir /tmp/ryba-hive-$ts
        cp -rp /var/log/hive/hive-server2.log.* /tmp/ryba-hive-$ts
        tar czf /tmp/ryba-hive-log-#{now}.tgz -C /tmp/ryba-hive-$ts .
        rm -rf /var/tmp/ryba-hive-$ts
        """
      , next


