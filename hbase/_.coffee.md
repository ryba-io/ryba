
# HBase

    hproperties = require '../lib/properties'
    module.exports = []
    module.exports.push 'masson/bootstrap/'
    module.exports.push 'masson/core/yum'
    module.exports.push 'ryba/hadoop/core'

## Configure

*   `hbase.user` (object|string)   
    The Unix HBase login name or a user object (see Mecano User documentation).   
*   `hbase.group` (object|string)   
    The Unix HBase group name or a group object (see Mecano Group documentation).   

Example

```json
    "hbase":{
      "user": {
        "name": "hbase", "system": true, "gid": "hbase",
        "comment": "HBase User", "home": "/var/run/hbase"
      },
      "group": {
        "name": "HBase", "system": true
      }
    }
```

    module.exports.push module.exports.configure = (ctx) ->
      return if ctx.hbase_configured
      ctx.hbase_configured = true
      require('masson/commons/java').configure ctx
      {java_home} = ctx.config.java
      {ryba} = ctx.config
      {static_host, realm} = ryba
      zookeeper_hosts = ctx.hosts_with_module('ryba/zookeeper/server').join ','
      # User
      hbase = ryba.hbase ?= {}
      hbase.user ?= {}
      hbase.user = name: ryba.hbase.user if typeof ryba.hbase.user is 'string'
      hbase.user.name ?= 'hbase'
      hbase.user.system ?= true
      hbase.user.gid ?= 'hbase'
      hbase.user.comment ?= 'HBase User'
      hbase.user.home ?= '/var/run/hbase'
      hbase.user.groups ?= 'hadoop'
      # Group
      hbase.group ?= {}
      hbase.group = name: hbase.group if typeof hbase.group is 'string'
      hbase.group.name ?= 'hbase'
      hbase.group.system ?= true
      # Layout
      hbase.conf_dir ?= '/etc/hbase/conf'
      hbase.log_dir ?= '/var/log/hbase'
      hbase.pid_dir ?= '/var/run/hbase'
      # Configuration
      hbase.site ?= {}
      hbase.site['zookeeper.znode.parent'] ?= '/hbase'
      # The mode the cluster will be in. Possible values are
      # false: standalone and pseudo-distributed setups with managed Zookeeper
      # true: fully-distributed with unmanaged Zookeeper Quorum (see hbase-env.sh)
      hbase.site['hbase.cluster.distributed'] = 'true'
      # Enter the HBase NameNode server hostname
      # http://www.cloudera.com/content/cloudera-content/cloudera-docs/CDH4/latest/CDH4-High-Availability-Guide/cdh4hag_topic_2_6.html
      nn_host = unless ctx.hosts_with_module('ryba/hadoop/hdfs_nn').length > 1
      then ctx.host_with_module 'ryba/hadoop/hdfs_nn'
      else ryba.nameservice
      hbase.site['hbase.rootdir'] ?= "hdfs://#{nn_host}:8020/apps/hbase/data"
      # hbase.site['hbase.rootdir'] ?= "hdfs://#{namenode}:8020/apps/hbase/data"
      # Comma separated list of Zookeeper servers (match to
      # what is specified in zoo.cfg but without portnumbers)
      hbase.site['hbase.zookeeper.quorum'] ?= "#{zookeeper_hosts}"
      # Short-circuit are true but socket.path isnt defined for hbase, only for hdfs, see http://osdir.com/ml/hbase-user-hadoop-apache/2013-03/msg00007.html
      hbase.site['dfs.domain.socket.path'] ?= '/var/lib/hadoop-hdfs/dn_socket'
      # Security
      hbase.site['hbase.security.authentication'] ?= 'kerberos' # Required by HM, RS and client
      hbase.site['hbase.security.authorization'] ?= 'true'
      hbase.site['hbase.rpc.engine'] ?= 'org.apache.hadoop.hbase.ipc.SecureRpcEngine'
      hbase.site['hbase.superuser'] ?= 'hbase'
      hbase.site['hbase.coprocessor.master.classes'] ?= 'org.apache.hadoop.hbase.security.access.AccessController'
      hbase.site['hbase.bulkload.staging.dir'] ?= '/apps/hbase/staging'
      # Secure Server Configuration
      hbase.site['hbase.coprocessor.region.classes'] ?= [
        'org.apache.hadoop.hbase.security.token.TokenProvider'
        'org.apache.hadoop.hbase.security.access.SecureBulkLoadEndpoint'
        'org.apache.hadoop.hbase.security.access.AccessController'
      ]
      hbase.site['hbase.coprocessor.region.classes'] = hbase.site['hbase.coprocessor.region.classes'].join ',' if Array.isArray hbase.site['hbase.coprocessor.region.classes']
      # Environment
      hbase.env ?=  {}
      hbase.env['JAVA_HOME'] ?= "#{java_home}"
      hbase.env['HBASE_LOG_DIR'] ?= "#{hbase.log_dir}"
      hbase.env['HBASE_OPTS'] ?= '-ea -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode'
      hbase.env['HBASE_MASTER_OPTS'] ?= '-Xmx1024m'
      hbase.env['HBASE_REGIONSERVER_OPTS'] ?= '-Xmx1024m'
      if ctx.has_module 'ryba/hbase/client'
      # if ctx.has_any_modules ['ryba/hbase/client', 'ryba/hbase/master', 'ryba/hbase/regionserver']
        hbase.env['HBASE_OPTS'] =  hbase.env['HBASE_OPTS'] + " -Djava.security.auth.login.config=#{hbase.conf_dir}/hbase-client.jaas"
      if ctx.has_module 'ryba/hbase/master'
        hbase.env['HBASE_MASTER_OPTS'] = hbase.env['HBASE_MASTER_OPTS'] + " -Djava.security.auth.login.config=#{hbase.conf_dir}/hbase-master.jaas"
      if ctx.has_module 'ryba/hbase/regionserver'
        hbase.env['HBASE_REGIONSERVER_OPTS'] = hbase.env['HBASE_REGIONSERVER_OPTS'] + " -Djava.security.auth.login.config=#{hbase.conf_dir}/hbase-regionserver.jaas"
      ryba.jaas_server ?= """
      Server {
      com.sun.security.auth.module.Krb5LoginModule required
      useKeyTab=true
      storeKey=true
      useTicketCache=false
      keyTab="/etc/hbase/conf/hbase.service.keytab"
      principal="hbase/#{ctx.config.host}";
      };
      """
      ryba.jaas_client ?= """
      Client {
      com.sun.security.auth.module.Krb5LoginModule required
      useKeyTab=false
      useTicketCache=true;
      };
      """
      require('../hadoop/core').configure ctx

## Users & Groups

By default, the "hbase" package create the following entries:

```bash
cat /etc/passwd | grep hbase
hbase:x:492:492:HBase:/var/run/hbase:/bin/bash
cat /etc/group | grep hbase
hbase:x:492:
```

    module.exports.push name: 'HBase # Users & Groups', handler: (ctx, next) ->
      {hbase} = ctx.config.ryba
      ctx.group hbase.group, (err, gmodified) ->
        return next err if err
        ctx.user hbase.user, (err, umodified) ->
          next err, gmodified or umodified

## Install

Instructions to [install the HBase RPMs](http://docs.hortonworks.com/HDPDocuments/HDP1/HDP-1.3.2/bk_installing_manually_book/content/rpm-chap9-1.html)

    module.exports.push name: 'HBase # Install', timeout: -1, handler: (ctx, next) ->
      ctx.service name: 'hbase', (err, serviced) ->
        next err, serviced

    module.exports.push name: 'HBase # Layout', timeout: -1, handler: (ctx, next) ->
      {hbase} = ctx.config.ryba
      ctx.mkdir [
        destination: hbase.pid_dir
        uid: hbase.user.name
        gid: hbase.group.name
        mode: 0o0755
      ,
        destination: hbase.log_dir
        uid: hbase.user.name
        gid: hbase.group.name
        mode: 0o0755
      ], next

    module.exports.push name: 'HBase # Env', handler: (ctx, next) ->
      {hbase} = ctx.config.ryba
      ctx.log 'Write hbase-env.sh'
      write = for k, v of hbase.env
        match: RegExp "export #{k}=.*", 'mg'
        replace: "export #{k}=\"#{v}\""
      ctx.upload
        source: "#{__dirname}/../resources/hbase/hbase-env.sh"
        destination: "#{hbase.conf_dir}/hbase-env.sh"
        write: write
        backup: true
      , next

    module.exports.push name: 'HBase # RegionServers', handler: (ctx, next) ->
      {hbase, hadoop_group} = ctx.config.ryba
      regionservers = ctx.hosts_with_module('ryba/hbase/regionserver').join '\n'
      ctx.write
        content: regionservers
        destination: "#{hbase.conf_dir}/regionservers"
        uid: hbase.user.name
        gid: hadoop_group.name
        eof: true
      , next

    module.exports.push name: 'HBase # Tuning', handler: (ctx, next) ->
      # http://hadoop-hbase.blogspot.fr/2014/03/hbase-gc-tuning-observations.html
      next null, 'TODO'

## Resources

[HBase: Performance Tunners (read optimization)](http://labs.ericsson.com/blog/hbase-performance-tuners)
[Scanning in HBase (read optimization)](http://hadoop-hbase.blogspot.com/2012/01/scanning-in-hbase.html)
[Configuring HBase Memstore (write optimization)](http://blog.sematext.com/2012/17/16/hbase-memstore-what-you-should-know/)
[Visualizing HBase Flushes and Compactions (write optimization)](http://www.ngdata.com/visiualizing-hbase-flushes-and-compactions/)


